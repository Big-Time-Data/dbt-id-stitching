DROP TABLE IF EXISTS rudderstack.rs_user_journey CASCADE;

with cte_user_journey as (
  Select distinct * 
  From 
      (
          Select distinct
              'Page' as event
              , p.title as event_text
              , p.anonymous_id
              , p.id as event_id
              , coalesce(p.user_id, (case when coalesce(u1.edge_label, u2.edge_label) = 'user_id' then coalesce(u1.edge, u2.edge) else null end) ) as user_id
              , case when coalesce(u1.edge_label, u2.edge_label) = 'email' then coalesce(u1.edge, u2.edge) else null end  as email
              , p.timestamp
              , p.channel
              --, p.context_campaign_click as campaign_click
              --, p.context_campaign_content as campaign_content
              , p.context_campaign_medium as campaign_medium
              , p.context_campaign_name as campaign_name
              , p.context_campaign_source as campaign_source
              --, p.context_campaign_term as campaign_term
              , p.context_page_referrer as referrer
              , p.context_page_url as url
              , p.title 
              , p.context_request_ip as ip
              , case when p.user_id is null and coalesce(u1.edge, u2.edge) is not null 
                     then 'Unknown' else 'Known' 
                     end as event_timing
        	  , coalesce(u1.rudder_id::text, u2.rudder_id::text, p.anonymous_id) as rudder_id
          From rudderstack.pages p 
             Left Outer Join rudderstack.rs_user_id_graph u1 on p.anonymous_id = u1.edge 
             Left Outer Join rudderstack.rs_user_id_graph u2 on p.user_id = u2.edge 

        	union all 

          Select Distinct
              t.event
              , t.event_text
              , t.anonymous_id
              , t.id as event_id
              , coalesce(t.user_id, (case when coalesce(u1.edge_label, u2.edge_label) = 'user_id' then coalesce(u1.edge, u2.edge) else null end) ) as user_id
              , case when coalesce(u1.edge_label, u2.edge_label) = 'email' then coalesce(u1.edge, u2.edge) else null end  as email
              , t.timestamp
              , t.channel
              --, t.context_campaign_click as campaign_click
              --, t.context_campaign_content as campaign_content
              , t.context_campaign_medium as campaign_medium
              , t.context_campaign_name as campaign_name
              , t.context_campaign_source as campaign_source
              --, t.context_campaign_term as campaign_term
              , t.context_page_referrer as referrer
              , t.context_page_url as url
              , t.context_page_title as title
              , t.context_request_ip as ip
              , case when t.user_id is null and coalesce(u1.edge, u2.edge) is not null 
                     then 'Unknown' else 'Known' 
                     end as event_timing
              , coalesce(u1.rudder_id::text, u2.rudder_id::text, t.anonymous_id) as rudder_id
          From rudderstack.tracks t 
              Left Outer Join rudderstack.rs_user_id_graph u1 on t.anonymous_id = u1.edge 
              Left Outer Join rudderstack.rs_user_id_graph u2 on t.user_id = u2.edge 
      ) user_journey
)

Select * 
    , extract(seconds from (timestamp - lag(timestamp) 
         over (order by rudder_id, timestamp)))  as time_lag
    , dense_rank() over (partition by rudder_id 
          order by timestamp asc, case when event = 'Page' then 1 else 2 end) 
          as user_event_step
INTO rudderstack.rs_user_journey
from cte_user_journey
order by timestamp; 


CREATE OR REPLACE VIEW rudderstack."qry_rs_user_journey"  
AS 

with cte_user_totals as (
  Select  rudder_id
        ,min(to_date(timestamp::text, 'YYYY-mm-01')) as cohort_first_touch
        ,min(case when user_event_step = 1 
                  then campaign_name else null end) as cohort_first_touch_campaign 
  	 ,min(case when event = 'order_completed' 
                  then to_date(timestamp::text, 'YYYY-mm-01') else null end) 
                  as cohort_first_order
  	 ,max(case when event = 'order_completed' 
                  then to_date(timestamp::text, 'YYYY-mm-01') else null end) 
                  as last_order_event
  	 ,count(distinct case when  event = 'order_completed'
              	   then timestamp else null end) as order_event_count
  FROM   rudderstack.rs_user_journey
  group by rudder_id  	
                    )

  SELECT uj.rudder_id,
         uj.event,
         uj.event_text,
         uj.anonymous_id,
         uj.user_id,
         uj.email,
         uj."timestamp",
         uj.channel,
--         uj.campaign_click,
--         uj.campaign_content,
         uj.campaign_medium,
         uj.campaign_name,
         uj.campaign_source,
--         uj.campaign_term,
         uj.referrer,
         uj.url,
         uj.title,
         uj.ip,
         uj.event_timing,
         uj.time_lag,
         uj.user_event_step,
         ut.cohort_first_touch,
         ut.cohort_first_touch_campaign, 
         ut.cohort_first_order,
  	  ut.last_order_event,
  	  ut.order_event_count
  FROM   rudderstack.rs_user_journey as uj
  	   Left outer join cte_user_totals ut on uj.rudder_id = ut.rudder_id;
  
  
